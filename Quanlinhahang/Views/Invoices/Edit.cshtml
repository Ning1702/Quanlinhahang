@model Quanlinhahang.Models.ViewModels.InvoiceEditVM
@{
    var monAn = (List<Quanlinhahang.Models.MonAn>)ViewBag.MonAn;
    ViewData["Title"] = $"Sửa hóa đơn #{Model.HoaDonID}";
    bool daXacNhan = (ViewBag.TrangThaiXacNhan == "Đã xác nhận");
    bool daThanhToan = (bool)(ViewBag.DaThanhToan ?? false);
    bool khongTheSua = daXacNhan && daThanhToan;
}

<h2 class="mt-3">Hóa đơn #@Model.HoaDonID</h2>

@if (TempData["msg"] != null)
{
    <div class="alert alert-success">@TempData["msg"]</div>
}

@if (khongTheSua)
{
    <div class="alert alert-warning">
        Hóa đơn này đã được xác nhận và thanh toán — bạn chỉ có thể xem, không thể chỉnh sửa.
    </div>
}
else if (daXacNhan)
{
    <div class="alert alert-info">
        Hóa đơn đã xác nhận — bạn chỉ có thể chỉnh sửa trạng thái thanh toán.
    </div>
}

<div class="row">
    <div class="col-md-7">
        <h5>Danh sách món</h5>
        <table class="table table-bordered">
            <thead>
                <tr><th>Tên món</th><th style="width:120px">SL</th><th class="text-end" style="width:160px">Đơn giá</th><th class="text-end">Thành tiền</th><th style="width:80px"></th></tr>
            </thead>
            <tbody>
                @foreach (var i in Model.Items)
                {
                    <tr>
                        <td>@i.TenMon</td>
                        <td>@i.SoLuong</td>
                        <td class="text-end">@i.DonGia.ToString("#,0")</td>
                        <td class="text-end">@i.ThanhTien.ToString("#,0")</td>
                        <td>
                            @if (!khongTheSua)
                            {
                                <form method="post" asp-action="RemoveItem">
                                    <input type="hidden" name="hoaDonId" value="@Model.HoaDonID" />
                                    <input type="hidden" name="monAnId" value="@i.MonAnID" />
                                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Xóa món này?')">Xóa</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (!khongTheSua)
        {
            <form method="post" asp-action="AddItem" class="row g-2">
                <input type="hidden" name="hoaDonId" value="@Model.HoaDonID" />
                <div class="col-md-7">
                    <select class="form-select" name="monAnId" required>
                        <option value="">-- Chọn món --</option>
                        @foreach (var m in monAn)
                        {
                            <option value="@m.MonAnID">@m.TenMon (@m.DonGia.ToString("#,0"))</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <input class="form-control" type="number" name="soLuong" min="1" value="1" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100">Thêm</button>
                </div>
            </form>
        }
    </div>

    <div class="col-md-5">
        <h5>Thông tin thanh toán</h5>
        <form method="post" asp-action="Save">
            <input type="hidden" asp-for="HoaDonID" />
            <input type="hidden" asp-for="DatBanID" />

            <fieldset @(khongTheSua ? "disabled" : "")>
                <div class="mb-2">
                    <label class="form-label">Giảm giá</label>
                    <input class="form-control" asp-for="GiamGia" type="number" step="1000" min="0" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Điểm sử dụng</label>
                    <input class="form-control" asp-for="DiemSuDung" type="number" min="0" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Hình thức thanh toán</label>
                    <select class="form-select" asp-for="HinhThucThanhToan">
                        <option value="">-- Chọn --</option>
                        <option>Tiền mặt</option>
                        <option>Thẻ</option>
                        <option>QR</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" asp-for="TrangThaiThanhToan">
                        <option>Chưa thanh toán</option>
                        <option>Đã thanh toán</option>
                    </select>
                </div>
            </fieldset>

            <button class="btn btn-success" @(khongTheSua ? "disabled" : "")>Lưu</button>
            <a class="btn btn-secondary" href="@Url.Action("Index")">Quay lại</a>
            <a class="btn btn-outline-dark" target="_blank" href="@Url.Action("Print", new { id = Model.HoaDonID })">In / Xuất PDF</a>
        </form>
    </div>
</div>
