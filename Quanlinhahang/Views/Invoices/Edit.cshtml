@model Quanlinhahang.Models.ViewModels.InvoiceEditVM
@using Microsoft.AspNetCore.Mvc.Rendering
@using Quanlinhahang.Models

@{
    var monAn = (List<Quanlinhahang.Models.MonAn>)ViewBag.MonAn;
    ViewData["Title"] = $"Sửa hóa đơn #{Model.HoaDonID}";

    bool daThanhToan = (bool)(ViewBag.DaThanhToan ?? false);

    string trangThaiTen = ViewBag.TrangThai as string;
    bool daXacNhan = (trangThaiTen == "Đã xác nhận");
    bool khongTheSua = daThanhToan;

    int status = ViewBag.Status ?? 0;   // <-- LẤY TRẠNG THÁI HIỆN TẠI

    // TÌM BANPHONG ĐÃ CHỌN ĐỂ HIỂN THỊ TÊN
    var banPhongDaChon = ((List<BanPhong>)ViewBag.BanPhongs)
                            .FirstOrDefault(b => b.BanPhongID == Model.BanPhongID);
    var tenBanDaChon = banPhongDaChon != null ? banPhongDaChon.TenBanPhong : "Không yêu cầu";
}

<h2 class="mt-3">Hóa đơn #@Model.HoaDonID</h2>

@if (TempData["msg"] != null)
{
    <div class="alert alert-success">@TempData["msg"]</div>
}

@if (khongTheSua)
{
    <div class="alert alert-warning">Hóa đơn này đã được thanh toán — bạn chỉ có thể xem.</div>
}
else if (daXacNhan)
{
    <div class="alert alert-info">Hóa đơn đã xác nhận — chỉ chỉnh sửa thanh toán.</div>
}

<div class="row">

    <div class="col-md-7">
        <h5>Danh sách món</h5>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Tên món</th>
                    <th style="width:150px;text-align:center">SL</th>
                    <th class="text-end" style="width:160px">Đơn giá</th>
                    <th class="text-end">Thành tiền</th>
                    <th style="width:80px"></th>
                </tr>
            </thead>

            <tbody>
                @foreach (var i in Model.Items)
                {
                    <tr>
                        <td>@i.TenMon</td>

                        <td class="text-center">
                            @if (!khongTheSua)
                            {
                                <div class="d-flex justify-content-center align-items-center">
                                    <form method="post" asp-action="RemoveItem" asp-controller="Invoices" class="me-1">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="hoaDonId" value="@Model.HoaDonID" />
                                        <input type="hidden" name="monAnId" value="@i.MonAnID" />
                                        <button class="btn btn-sm btn-outline-secondary px-2" @(i.SoLuong <= 1 ? "disabled" : "")>-</button>
                                    </form>

                                    <span class="mx-2 fw-bold">@i.SoLuong</span>

                                    <form method="post" asp-action="AddItem" asp-controller="Invoices" class="ms-1">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="hoaDonId" value="@Model.HoaDonID" />
                                        <input type="hidden" name="monAnId" value="@i.MonAnID" />
                                        <input type="hidden" name="soLuong" value="1" />
                                        <button class="btn btn-sm btn-outline-secondary px-2">+</button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                @i.SoLuong
                            }
                        </td>

                        <td class="text-end">@i.DonGia.ToString("#,0")</td>
                        <td class="text-end">@i.ThanhTien.ToString("#,0")</td>

                        <td>
                            @if (!khongTheSua)
                            {
                                <form method="post"
                                      asp-action="RemoveItem"
                                      asp-controller="Invoices"
                                      onsubmit="return confirm('Xóa món này?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="hoaDonId" value="@Model.HoaDonID" />
                                    <input type="hidden" name="monAnId" value="@i.MonAnID" />
                                    <input type="hidden" name="removeAll" value="true" />
                                    <button class="btn btn-sm btn-outline-danger">Xóa</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>

            @{
                var sub = Model.Items.Sum(x => x.ThanhTien);
                var vat = sub * 0.1m;
                var final = sub + vat - Model.GiamGia - Model.DiemSuDung;
                if (final < 0) final = 0;
            }

            <tfoot class="table-light">
                <tr>
                    <td colspan="3" class="text-end fw-bold">Tạm tính:</td>
                    <td class="text-end fw-bold">@sub.ToString("#,0")</td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="3" class="text-end">VAT (10%)</td>
                    <td class="text-end">@vat.ToString("#,0")</td>
                </tr>
                @if (Model.GiamGia > 0)
                {
                    <tr>
                        <td colspan="3" class="text-end text-danger">Giảm giá</td>
                        <td class="text-end text-danger">-@Model.GiamGia.ToString("#,0")</td>
                    </tr>
                }
                @if (Model.DiemSuDung > 0)
                {
                    <tr>
                        <td colspan="3" class="text-end text-danger">Dùng điểm</td>
                        <td class="text-end text-danger">-@Model.DiemSuDung.ToString("#,0")</td>
                    </tr>
                }
                <tr class="h5">
                    <td colspan="3" class="text-end fw-bold">Thành tiền:</td>
                    <td class="text-end fw-bold">@final.ToString("#,0")</td>
                </tr>
            </tfoot>
        </table>

        @if (!khongTheSua)
        {
            <form method="post" asp-action="AddItem" asp-controller="Invoices" class="row g-2">
                @Html.AntiForgeryToken()
                <input type="hidden" name="hoaDonId" value="@Model.HoaDonID" />

                <div class="col-md-7">
                    <select class="form-select" name="monAnId" required>
                        <option value="">-- Chọn món --</option>
                        @foreach (var m in monAn)
                        {
                            <option value="@m.MonAnID">@m.TenMon (@m.DonGia.ToString("#,0"))</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <input type="number" class="form-control" name="soLuong" min="1" value="1" />
                </div>

                <div class="col-md-2">
                    <button class="btn btn-primary w-100">Thêm</button>
                </div>
            </form>
        }
    </div>

    <div class="col-md-5">

        <h5>Thông tin thanh toán</h5>
        <form method="post" asp-action="Save" asp-controller="Invoices">
            @Html.AntiForgeryToken()

            <input type="hidden" asp-for="HoaDonID" />
            <input type="hidden" asp-for="DatBanID" />

            <input type="hidden" asp-for="BanPhongID" id="selectedBanPhongID" />

            <!-- GIỮ STATUS ĐỂ QUAY LẠI ĐÚNG TAB -->
            <input type="hidden" name="status" value="@status" />

            <fieldset>

                <div class="mb-3">
                    <label class="form-label fw-bold">Chọn bàn / phòng phục vụ</label>
                    <div class="input-group">
                        <input type="text" id="selectedBanPhongName" class="form-control" value="@tenBanDaChon" readonly
                               placeholder="Chưa chọn bàn" />

                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#banPhongModal"
                                @(khongTheSua ? "disabled" : "")>
                            Chọn
                        </button>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label">Giảm giá</label>
                    <input asp-for="GiamGia"
                           type="number"
                           min="0"
                           step="1000"
                           class="form-control"
                           value="@(Model.GiamGia.ToString("0"))" />

                </div>

                <div class="mb-2">
                    <label class="form-label">Điểm sử dụng</label>
                    <input asp-for="DiemSuDung" type="number" min="0" class="form-control" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Hình thức thanh toán</label>
                    <select class="form-select" asp-for="HinhThucThanhToan">
                        <option value="">-- Chọn --</option>
                        <option>Tiền mặt</option>
                        <option>Thẻ</option>
                        <option>QR</option>
                    </select>
                </div>

            </fieldset>

            <button class="btn btn-success" @(khongTheSua ? "disabled" : "")>Lưu</button>

            <a class="btn btn-secondary"
               href="@Url.Action("Index", new { status = status })">
                Quay lại
            </a>

        </form>
    </div>

</div>

<!-- MODAL BÀN/PHÒNG GIỮ NGUYÊN -->
<div class="modal fade" id="banPhongModal" tabindex="-1" aria-labelledby="banPhongModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="banPhongModalLabel">Chọn bàn / phòng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="banPhongTab" role="tablist">
                </ul>

                <div class="tab-content p-3 border border-top-0" id="banPhongTabContent">
                    <div class="text-center p-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS + JS GIỮ NGUYÊN -->
<style>
    .table-grid-item {
        min-width: 100px;
        height: 80px;
        border: 1px solid #ccc;
        border-radius: 5px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        padding: 5px;
        font-size: 0.9rem;
    }

    .table-available {
        background-color: #f8f9fa;
        color: #212529;
    }

        .table-available:hover {
            background-color: #e2e6ea;
            border-color: #0d6efd;
        }

    .table-occupied {
        background-color: #ffc107;
        color: #333;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .table-current {
        background-color: #0d6efd;
        color: white;
        border-color: #0a58ca;
    }

        .table-current:hover {
            background-color: #0b5ed7;
        }

        .table-current small {
            color: #eee;
        }

    .table-grid-item small {
        font-size: 0.8em;
        font-weight: normal;
        color: #555;
    }
</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            var myModal = new bootstrap.Modal(document.getElementById('banPhongModal'));
            var banPhongList = [];
            var currentSelectedID = $('#selectedBanPhongID').val();

            $('#banPhongModal').on('show.bs.modal', function () {
                loadBanPhongData();
            });

            function loadBanPhongData() {
                var tabContainer = $('#banPhongTab');
                var tabContent = $('#banPhongTabContent');
                tabContent.html('<div class="text-center p-5"><div class="spinner-border"></div></div>');
                tabContainer.empty();

                $.ajax({
                    url: '@Url.Action("GetBanPhongStatus", "Invoices")',
                    type: 'GET',
                    success: function (tables) {
                        banPhongList = tables;
                        tabContent.empty();

                        var groups = [...new Map(tables.map(item =>
                            [item.loaiBanPhong.loaiBanPhongID, item.loaiBanPhong]
                        )).values()];

                        groups.sort((a, b) => a.loaiBanPhongID - b.loaiBanPhongID);

                        groups.forEach(function (group, index) {
                            var isActive = index === 0;

                            var tab =
                                `<li class="nav-item">
                                    <button class="nav-link ${isActive ? 'active' : ''}"
                                            data-bs-target="#tab-pane-${group.loaiBanPhongID}"
                                            data-bs-toggle="tab">${group.tenLoai}</button>
                                </li>`;
                            tabContainer.append(tab);

                            var pane =
                                `<div class="tab-pane fade ${isActive ? 'show active' : ''}"
                                      id="tab-pane-${group.loaiBanPhongID}">
                                 </div>`;
                            tabContent.append(pane);

                            var list = tables.filter(t => t.loaiBanPhongID === group.loaiBanPhongID);
                            renderGroup(list, `#tab-pane-${group.loaiBanPhongID}`);
                        });

                    },
                    error: function () {
                        tabContent.html('<div class="alert alert-danger">Không thể tải danh sách bàn.</div>');
                    }
                });
            }

            function renderGroup(tables, container) {
                var wrap = $('<div class="d-flex flex-wrap gap-2"></div>');
                currentSelectedID = $('#selectedBanPhongID').val();

                tables.forEach(function (ban) {
                    var isOccupied = ban.trangThai.toLowerCase() !== 'trống';
                    var isCurrent = ban.banPhongID == currentSelectedID;

                    var css = isCurrent ? "table-current" : (isOccupied ? "table-occupied" : "table-available");

                    wrap.append(`
                        <div class="table-grid-item ${css}"
                             data-id="${ban.banPhongID}"
                             data-name="${ban.tenBanPhong}"
                             data-occupied="${isOccupied}">
                            <span>${ban.tenBanPhong}</span>
                            <small>Sức chứa: ${ban.sucChua}</small>
                        </div>
                    `);
                });

                $(container).html(wrap);
            }

            $('#banPhongTabContent').on('click', '.table-grid-item:not(.table-occupied)', function () {
                $('#selectedBanPhongID').val($(this).data('id'));
                $('#selectedBanPhongName').val($(this).data('name'));
                myModal.hide();
            });
        });
    </script>
}
